# shellcheck shell=bash

CPU_TYPE=$(arch -arm64 uname -m 2> /dev/null || uname -m)

GDK_CUSTOM_RC_FILE=".gdkrc.custom"

if [[ -f "${GDK_CUSTOM_RC_FILE}" ]]; then
  # shellcheck disable=SC1090
  source "${GDK_CUSTOM_RC_FILE}"
fi

export GDK_ASDF_PREBUILT_PACKAGES="${GDK_ASDF_PREBUILT_PACKAGES:-false}"

if [[ "${GDK_ASDF_PREBUILT_PACKAGES}" == "true" ]]; then
  export ASDF_DIR="/opt/asdf"
  export ASDF_DIR_ASDF_SH="${ASDF_DIR}/asdf.sh"
  export ASDF_DATA_DIR="${ASDF_DIR}"

  [[ -f "${ASDF_DIR_ASDF_SH}" ]] && source "${ASDF_DIR_ASDF_SH}"
fi

# macOS
#
if [[ "${OSTYPE}" == "darwin"* ]]; then
  if [[ -x "/opt/homebrew/bin/brew" ]]; then
    BREW_PREFIX="/opt/homebrew"
  elif [[ -x "/usr/local/bin/brew" ]]; then
    BREW_PREFIX="/usr/local"
  else
    echo "ERROR: Homebrew is required but cannot be found."
    exit
  fi

  OPENSSL_PREFIX="${BREW_PREFIX}/opt/openssl@1.1"
  READLINE_PREFIX="${BREW_PREFIX}/opt/readline"
  ICU4C_PREFIX="${BREW_PREFIX}/opt/icu4c"

  export LDFLAGS="-L${OPENSSL_PREFIX}/lib"
  export CPPFLAGS="-I${OPENSSL_PREFIX}/include"
  export PKG_CONFIG_PATH="${OPENSSL_PREFIX}/lib/pkgconfig:${ICU4C_PREFIX}/lib/pkgconfig"
  export RUBY_CONFIGURE_OPTS="--with-openssl-dir=${OPENSSL_PREFIX} --with-readline-dir=${READLINE_PREFIX}"

  if [[ "${CPU_TYPE}" == "arm64" && "${GDK_MACOS_ARM64_NATIVE}" == "true" ]]; then
    export LIBPCREDIR="${BREW_PREFIX}/opt/pcre2"
  fi
fi

export GDK_ENV_LOADED=1
