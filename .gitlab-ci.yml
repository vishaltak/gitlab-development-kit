---
stages:
  - pre
  - build
  - test
  - analyze
  - pre-verify
  - verify
  - deploy

variables:
  DEFAULT_IMAGE: $CI_REGISTRY_IMAGE/asdf-bootstrapped-verify:$CI_COMMIT_REF_SLUG
  GITLAB_E2E_IMAGE: $CI_REGISTRY_IMAGE/asdf-bootstrapped-gdk-installed-gitlab-e2e:$CI_COMMIT_REF_SLUG
  VERIFY_FULL_IMAGE: $CI_REGISTRY_IMAGE/asdf-bootstrapped-gdk-installed-full:$CI_COMMIT_REF_SLUG
  VERIFY_IMAGE: $CI_REGISTRY_IMAGE/asdf-bootstrapped-gdk-installed:$CI_COMMIT_REF_SLUG
  GITPOD_WORKSPACE_IMAGE_BASE: $CI_REGISTRY_IMAGE/gitpod-workspace
  GITPOD_WORKSPACE_IMAGE: $CI_REGISTRY_IMAGE/gitpod-workspace:$CI_COMMIT_REF_SLUG
  GITLAB_CI_CACHE_DIR: .gitlab-ci-cache
  GITLAB_CI_CACHE_FULL_DIR: $CI_PROJECT_DIR/$GITLAB_CI_CACHE_DIR
  GITLAB_CI_CACHE_GO_DIR: $GITLAB_CI_CACHE_DIR/go
  BUNDLE_PATH: "vendor/bundle"
  BUNDLE_FROZEN: "true"
  BUNDLE_JOBS: "$(nproc)"
  ENABLE_BOOTSNAP: "false"
  PUMA_SINGLE_MODE: "true"
  GDK_DEBUG: "true"
  NOKOGIRI_LIBXML_MEMORY_MANAGEMENT: "default"
  GITLAB_LAST_VERIFIED_SHA_PATH: gitlab-last-verified-sha.json

default:
  timeout: 3h
  interruptible: true
  image: ${DEFAULT_IMAGE}
  tags:
    - gitlab-org

.default-before_script:
  before_script:
    - sysctl -n -w fs.inotify.max_user_watches=524288 || true
    - |
      if [ -f support/ci/utils.sh ]; then
        . support/ci/utils.sh;
        display_debugging || true;
      else
        true;
      fi

## Cache definitions
.cache-variables:
  variables:
    BUNDLE_PATH: "${GITLAB_CI_CACHE_DIR}/bundle"
    GEM_HOME: "${GITLAB_CI_CACHE_DIR}/gem"
    GEM_PATH: "${GITLAB_CI_CACHE_DIR}/gem"
    GOMODCACHE: "${GITLAB_CI_CACHE_DIR}/go/mod"
    NODE_PATH: "${GITLAB_CI_CACHE_DIR}/nodejs"

.build-verify-image-cache-definition: &build-verify-image-cache-definition
  key:
    files:
      - ".tool-versions"
  paths:
    - "${BUNDLE_PATH}/"
    - "${GEM_PATH}/"
    - "${GOMODCACHE}/"
    - "${NODE_PATH}/"
  policy: pull

.build-verify-image-cache-definition-push: &build-verify-image-cache-definition-push
  <<: *build-verify-image-cache-definition
  policy: push  # We want to rebuild the cache from scratch to ensure stale dependencies are cleaned up.

.build-verify-image-cache:
  extends: .cache-variables
  cache:
    - *build-verify-image-cache-definition

.build-verify-image-cache-push:
  extends: .build-verify-image-cache
  cache:
    - *build-verify-image-cache-definition-push

include:
  - template: Workflows/MergeRequest-Pipelines.gitlab-ci.yml
  - local: .gitlab/ci/_rules.gitlab-ci.yml
  - local: .gitlab/ci/_docker.gitlab-ci.yml
  - local: .gitlab/ci/pre.gitlab-ci.yml
  - local: .gitlab/ci/build.gitlab-ci.yml
  - local: .gitlab/ci/test.gitlab-ci.yml
  - local: .gitlab/ci/analyze.gitlab-ci.yml
  - local: .gitlab/ci/pre-verify.gitlab-ci.yml
  - local: .gitlab/ci/verify.gitlab-ci.yml
  - local: .gitlab/ci/deploy.gitlab-ci.yml
