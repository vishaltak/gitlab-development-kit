.deploy-job:
  stage: deploy

yard:
  extends: .deploy-job
  image: "ruby:${RUBY_VERSION}"
  script:
    - bundle install
    - bundle exec yardoc
  cache:
    key: "ruby-2.7-bundle"
    paths:
      - $BUNDLE_PATH
  artifacts:
    expire_in: 1 week
    paths:
      - yard/*
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  parallel:
    matrix:
      - RUBY_VERSION: ['2.7', '3.0']

pages:
  extends: .deploy-job
  needs:
    - job: yard
      artifacts: true
  script:
    - cp -r yard public
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

tested-gitpod-workspace-image:
  extends:
    - .deploy-job
    - .docker:build-docker-in-docker
    - .rules:tested-deploy-gitpod-workspace-image
  needs:
    - build-gitpod-workspace-image
    - gitpod-docker-image
  script:
    - support/gitpod/docker-tag-image-tested

gitpod-workspace-image:
  extends:
    - .deploy-job
    - .docker:build-docker-in-docker
    - .rules:deploy-gitpod-workspace-image
  needs:
    - build-gitpod-workspace-image
    - tested-gitpod-workspace-image
  script:
    - ./support/gitpod/docker-tag-image-as-stable
