#!/usr/bin/env ruby
# frozen_string_literal: true

# Example:
#
#   ./support/component-git-clone <depth_param> <repo_name> <component_name> --revision <revision>
#

require 'optparse'
require_relative '../lib/gdk'

PROGNAME = File.basename(__FILE__)

def clone(git_clone_args)
  default_args = ['--quiet']
  command = %w[git clone] + default_args + git_clone_args

  3.times do
    sh = Shellout.new(command)
    sh.stream
    return true if sh.success?
  end

  false
end

def checkout(revision)
  %W[git checkout #{revision}]
end

def main(argv)
  options = {}
  extra_options = []

  opts = OptionParser.new do |opt|
    opt.on('--revision [string]') do |value|
      options[:revision] = value
    end
  end

  begin
    opts.parse!(argv)
  rescue OptionParser::InvalidOption => e
    extra_options << e.args
    retry
  end

  args = argv.concat(extra_options.flatten)
  clone(args)
  checkout(options[:revision]) unless options[:revision].nil?
end

abort "Usage: #{PROGNAME} [options] --revision [string]" if ARGV.count < 1

main(ARGV)
