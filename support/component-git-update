#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../lib/gdk/config'

PROGNAME = File.basename(__FILE__)

def auto_update_component?(component)
  config = GDK::Config.new[component]
  abort "unknown component: #{component.inspect}" unless config

  config.auto_update
end

def update_component(revision)
  [
    %w[git stash --quiet],
    %w[git fetch --all --tags --prune],
    %W[git checkout #{revision}],
  ].each do |cmd|
    next if system(*cmd)

    abort "command failed: #{cmd.join(' ')}"
  end
end

def main(component, worktree, revision)
  unless auto_update_component?(component)
    warn "#{PROGNAME}: auto update for #{component} is disabled via gdk.yml"
    exit
  end

  Dir.chdir(worktree)

  update_component(revision)
end

abort "usage: #{PROGNAME} COMPONENT WORKTREE REVISION" if ARGV.count!= 3

main(*ARGV)
