#!/bin/sh

GITPOD_WORKSPACE_IMAGE="${GITPOD_WORKSPACE_IMAGE:-gitpod-image}"

cd ./support/gitpod || exit 1
echo "Building ${GITPOD_WORKSPACE_IMAGE}"
docker buildx build \
  --build-arg git_checkout_branch="${CI_MERGE_REQUEST_SOURCE_BRANCH_SHA:-${CI_COMMIT_SHA}}" \
  --build-arg git_remote_origin_url="${CI_MERGE_REQUEST_SOURCE_PROJECT_URL:-}" \
  --tag "${GITPOD_WORKSPACE_IMAGE}" \
  --load \
  .

if [ "$CI" = "true" ]; then
  docker push "${GITPOD_WORKSPACE_IMAGE}"
fi
