#!/bin/bash

MAX_ATTEMPTS=90
START_TIME="$(date +%s)"

QUIET="${QUIET:-true}"
HOST="${1:-$(gdk config get __uri)}"
FULL_URL="${HOST}/users/sign_in"

display_duration() {
  local duration
  duration="$(($(date +%s)-START_TIME))"

  echo "${duration} second(s)"
}

if [[ "${QUIET}" == "false" ]]; then
  SLEEP_BETWEEN_ATTEMPTS=5
  CURL_OPTIONS=(--show-error)
else
  SLEEP_BETWEEN_ATTEMPTS=1
  CURL_OPTIONS=(--output /dev/null)
fi

for i in $(seq 1 ${MAX_ATTEMPTS})
do
  if [[ "${QUIET}" == "false" ]]; then
    echo "> Testing attempt #${i}.."
  else
    echo -n '.'
  fi

  if curl --head --silent --fail "${CURL_OPTIONS[@]}" "${FULL_URL}"; then
    echo
    echo "${FULL_URL} is up! Took $(display_duration)."
    exit 0
  fi

  [[ "${QUIET}" == "false" ]] && echo
  sleep ${SLEEP_BETWEEN_ATTEMPTS}
done

echo
echo "${FULL_URL} does not appear to be up. Waited $(display_duration)."
exit 1
